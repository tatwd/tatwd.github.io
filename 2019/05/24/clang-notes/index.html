<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="ie=edge"><!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> --><meta name="generator" content="Hexo 5.3.0"><meta name="description" content="C 是我学的第一门程序语言，也是让我认识和接触计算机、软件开发的开始。至今想来，我的思维有时侯其实存在的最多的还是面向过程的。 常见的 C 的标准：C89，C90，C99，C11。其中，C89、C90 标准相同，又称 ASCI C；C99 应用最广,我当时学的就是这个标准。 在这里，我想将后来学习的 C++、C#、Java、JavaScript 统称为“C 系语言”。虽然它们与 C 是如此的不同。"><meta property="og:type" content="article"><meta property="og:title" content="从 C 语言到程序的一般性问题讨论"><meta property="og:url" content="https://jin.cloong.me/2019/05/24/clang-notes/index.html"><meta property="og:site_name" content="_King&#39;s Notes"><meta property="og:description" content="C 是我学的第一门程序语言，也是让我认识和接触计算机、软件开发的开始。至今想来，我的思维有时侯其实存在的最多的还是面向过程的。 常见的 C 的标准：C89，C90，C99，C11。其中，C89、C90 标准相同，又称 ASCI C；C99 应用最广,我当时学的就是这个标准。 在这里，我想将后来学习的 C++、C#、Java、JavaScript 统称为“C 系语言”。虽然它们与 C 是如此的不同。"><meta property="og:locale"><meta property="og:image" content="https://jin.cloong.me/2019/05/24/clang-notes/1.png"><meta property="og:image" content="https://jin.cloong.me/2019/05/24/clang-notes/2.png"><meta property="og:image" content="https://jin.cloong.me/2019/05/24/clang-notes/3.png"><meta property="og:image" content="https://jin.cloong.me/2019/05/24/clang-notes/5.svg"><meta property="og:image" content="https://jin.cloong.me/2019/05/24/clang-notes/6.svg"><meta property="og:image" content="https://jin.cloong.me/2019/05/24/clang-notes/4.png"><meta property="article:published_time" content="2019-05-23T16:06:21.000Z"><meta property="article:modified_time" content="2021-03-04T15:53:12.065Z"><meta property="article:author" content="_king"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://jin.cloong.me/2019/05/24/clang-notes/1.png"><link rel="icon" href=""><title>_King&#39;s Notes</title><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Open+Sans|Roboto+Mono" rel="stylesheet"> --><!-- <link href="https://fonts.lug.ustc.edu.cn/css?family=Montserrat|Open+Sans|Roboto+Mono" rel="stylesheet"> --><link rel="stylesheet" href="/fonts/index.css"><link rel="stylesheet" href="/css/common.css"><style>.avatar::before{display:block;content:'';background:url(/img/avatar.jpg) no-repeat center;background-size:cover;border-radius:50%;border:1px solid #e6e6e6;height:62px;width:62px;margin:0 auto;margin-top:32px}</style><link rel="stylesheet" href="/css/post.css"><link rel="stylesheet" href="/css/prism.css"><link rel="stylesheet" href="/css/comment.css"><script>!function(){document.addEventListener("DOMContentLoaded",function(e){var o=window.decodeURI(location.hash.replace("#",""));if(""!==o){var t=document.getElementById(o);if(console.log(t),t){var n=t.offsetTop;setTimeout(function(){window.scrollTo(0,n-0)},0)}}});var e=(new Date).getHours();(e<6||18<=e)&&document.querySelector("html").setAttribute("theme","dark"),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){console.log(e)})}()</script><link rel="alternate" href="/atom.xml" title="_King's Notes" type="application/atom+xml"></head><body><div class="container"><div id="post"><div id="index__header"><div class="avatar text-center"></div><h2 class="h2 text-center text-upper"><a class="color--black" href="/">_King&#39;s Notes</a></h2><div class="text-center"><!-- github icon --> <a class="goto" href="https://github.com/tatwd" target="_blank"><svg class="icon" width="16" height="16" viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg> </a><a class="goto" href="mailto:tatwdo@gmail.com"><svg class="icon" width="16" height="16" viewBox="0 0 1024 1024" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M512 0a512 512 0 0 0 0 1024 42.666667 42.666667 0 0 0 0-85.333333 426.666667 426.666667 0 1 1 426.666667-426.666667v85.333333a85.333333 85.333333 0 1 1-169.386667 0V298.666667a42.666667 42.666667 0 0 0-85.333333 0v22.4a257.28 257.28 0 1 0 21.333333 359.253333A170.666667 170.666667 0 0 0 1024 597.333333v-85.333333A512 512 0 0 0 512 0z m0 683.946667A171.946667 171.946667 0 1 1 683.946667 512 172.16 172.16 0 0 1 512 683.946667z"></path></svg> </a><a class="goto" href="https://jin.cloong.me/atom.xml" target="_blank"><svg class="icon" width="16" height="16" viewBox="0 0 1024 1024" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M320.374394 768q0 45.714286-32 77.714286t-77.714285 32-77.714286-32-32-77.714286 32-77.714286 77.714286-32 77.714285 32 32 77.714286z m292.571429 70.285714q1.142857 16-9.714286 27.428572-10.285714 12-26.857143 12H499.231537q-14.285714 0-24.571428-9.428572t-11.428572-23.714285q-12.571429-130.857143-105.428571-223.714286T134.08868 515.428571q-14.285714-1.142857-23.714286-11.428571T100.945823 479.428571V402.285714q0-16.571429 12-26.857143 9.714286-9.714286 24.571428-9.714285h2.857143q91.428571 7.428571 174.857143 46T463.231537 515.428571q65.142857 64.571429 103.714286 148t46 174.857143z m292.571428 1.142857q1.142857 15.428571-10.285714 26.857143-10.285714 11.428571-26.285714 11.428572h-81.714286q-14.857143 0-25.428571-10T750.660109 843.428571q-6.857143-122.857143-57.714286-233.428571t-132.285714-192-192-132.285714T135.231537 227.428571q-14.285714-0.571429-24.285714-11.142857T100.945823 191.428571V109.714286q0-16 11.428571-26.285715 10.285714-10.285714 25.142857-10.285714h1.714286q149.714286 7.428571 286.571429 68.571429T668.945823 309.714286q106.857143 106.285714 168 243.142857t68.571428 286.571428z"></path></svg></a></div></div><div id="post__mainer"><div class="sm-container"><div class="post--body"><div class="post__title"><span>2019-05-24 12:06:21</span><h1 class="h1 text-upper">从 C 语言到程序的一般性问题讨论</h1></div><div class="post__content"><p>C 是我学的第一门程序语言，也是让我认识和接触计算机、软件开发的开始。至今想来，我的思维有时侯其实存在的最多的还是面向过程的。</p><p>常见的 C 的标准：C89，C90，C99，C11。其中，C89、C90 标准相同，又称 ASCI C；C99 应用最广,我当时学的就是这个标准。</p><p>在这里，我想将后来学习的 C++、C#、Java、JavaScript 统称为“C 系语言”。虽然它们与 C 是如此的不同。</p><h2 id="空指针和函数指针"><a href="#空指针和函数指针" class="headerlink" title="空指针和函数指针"></a>空指针和函数指针</h2><p>空指针 <code>void *</code> 和函数指针的存在是我以前常常忽视的两种特殊的指针。实际上，它们在 C 语言的开发中扮演着极为重要的角色，也与上述提及那些语言存在着极为密切的关系。</p><h3 id="1、空指针"><a href="#1、空指针" class="headerlink" title="1、空指针"></a>1、空指针</h3><p>空指针不代表任何类型，却可以成为任何类型。对它的赋值和转化必须按照相同的类型进行，以保证数据前后的一致性。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> foo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span>bar <span class="token operator">=</span> foo<span class="token punctuation">;</span>
<span class="token keyword">int</span> baz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>bar<span class="token punctuation">;</span> <span class="token comment">/* 1 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>也就是说，不一致的转换将在大多数情况下照成数据的缺失。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> foo <span class="token operator">=</span> <span class="token number">65540</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span>bar <span class="token operator">=</span> foo<span class="token punctuation">;</span>
<span class="token keyword">short</span> baz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span>bar<span class="token punctuation">;</span> <span class="token comment">/* 4 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这是因为在 C 语言中，类型转换是根据类型的大小重新对内存进行规划的（如图 1）。毫无疑问，在其它的语言当中亦是如此（基本值类型）。空指针的大小根据操作系统的位数来决定（包括其它类型的指针），一般是 32 位系统是 4 字节，64 位系统是 8 字节。</p><img src="/2019/05/24/clang-notes/1.png" class="" title="图 1"><p>空指针必须进行类型转换后才能访问。这有点像面向对象语言中的 <code>Object</code> 类型的实例，只有在经过类型转换（如拆箱）后它才会有实际意义。</p><p>另一方面，空指针的存在也让 C 具有了一定的<strong>泛型</strong>或<strong>模板化</strong>编程的可能性。比如，可以利用它写出一个能交换两个任意类型变量值的程序出来。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span> <span class="token comment">/* memcpy */</span></span>

<span class="token comment">/* size 是对应指针类型的大小(单位: Byte) */</span>
<span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ap<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>bp<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> ap<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> bp<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>bp<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个 <code>swap</code> 将可以进行不同类型的变量交换，如：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">char</span> <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token string">"bar"</span><span class="token punctuation">;</span>
<span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也即是说，利用空指针可以写出适应不同类型的通用模型或数据结构出来。</p><h3 id="2、函数指针"><a href="#2、函数指针" class="headerlink" title="2、函数指针"></a>2、函数指针</h3><p>函数指针可以将某个程序的操作延迟到调用，让程序适应不同的调用场景。这与面向对象语言的<strong>多态</strong>特点类似。</p><p>函数指针扮演的实际上是回调函数的角色。JavaScript 充分发挥了这一特性。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 使用 cmp 控制升序、降序 */</span>
<span class="token keyword">void</span> <span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">int</span> arr<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>cmp<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    <span class="token keyword">int</span> cur<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        cur <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">cmp</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span>
            arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> cur<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上述程序中，可以在调用该排序函数时，进行具体的 <code>cmp</code> 绑定，从而让该排序函数具有升序和降序的可能性。</p><p>倘若在一个结构体中定义一些系列的通用函数指针，对于不同的使用对象分别给出各自不同的实现，这样就可以实现面向接口化的编程，而这里的结构体又可以类比成一个<strong>接口</strong>。在 UNIX 操作系统中，<code>FILE</code> 这一结构就是这样设计的。</p><h2 id="内存对齐"><a href="#内存对齐" class="headerlink" title="内存对齐"></a>内存对齐</h2><blockquote><p>作者的机器是 64 位 Linux 系统，Intel x86 架构处理器</p></blockquote><p>内存<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Data_structure_alignment">对齐</a>实际是因为 CPU 的寻址方式所造成的一种对内存分配的优化手段。例如，有些 CPU 每次只能对 4 的倍数的地址进行读取，即每次只能读取 4 字节大小的数据，倘若有数据分布于两段地址区间内，那么 CPU 对该数据的读取将花费 2 次进行（如图 2）。一般而言，经过对齐之后的程序的运行效率高于未作处理的程序。</p><img src="/2019/05/24/clang-notes/2.png" class="" title="图 2"><p>在 C 语言中可以对内存对齐进行控制，特别是在结构体 <code>struct</code> 中进行这种处理是十分常见的。结构体实际上是一些数据的容器。当对结构体进行地址空间的分配时，实际将根据成员变量的类型及定义顺序进行，并按照默认的对齐方式对内存进行大小分配；成员变量定义的顺序不同，分配的大小可能不同。</p><p>一个空的结构体 <code>sizeof</code> 得到的是 <code>0</code>（单位字节，下同）。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">person_t</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span> <span class="token comment">/* 4 */</span>
    <span class="token keyword">short</span> age<span class="token punctuation">;</span> <span class="token comment">/* 2 */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span> <span class="token comment">/* 8 */</span>
    <span class="token keyword">char</span> gender<span class="token punctuation">;</span> <span class="token comment">/* 1 */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>理论上结构体 <code>struct person_t</code> 的内存分配的大小为 <code>4 + 2 + 8 + 1 = 15</code>，实际为 <code>24</code>。这是因为实际分配内存时，在 <code>age</code> 和 <code>name</code> 之间填充（Padding）了 2 字节大小的空间，在 <code>gender</code> 后填充了 7 字节大小的空间。</p><p>既然如此，实际当中我们是可以利用这一特性对程序进行内存级别的优化，以减小对内存的占用。例如，针对上面的结构体，可以通过调整结构体中的成员变量的顺序以达到减小内存的目的。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">person_t</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span> <span class="token comment">/* 4 */</span>
    <span class="token keyword">short</span> age<span class="token punctuation">;</span> <span class="token comment">/* 2 */</span>
    <span class="token keyword">char</span> gender<span class="token punctuation">;</span> <span class="token comment">/* 1 */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span> <span class="token comment">/* 8 */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样，将只在 <code>gender</code> 和 <code>name</code> 之间填充 1 字节的空间，从而使整个结构体占用的内存空间减小到 16 字节。这在实际应用当中是极为可观的。</p><p>因此，对结构体成员变量的定义顺序，一般都遵循着按<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Data_structure_alignment#Typical_alignment_of_C_structs_on_x86">对齐长度</a>从小到大或从大到小的规则排列。</p><p>那么，在其他的面向对象的语言里是否也会发生内存对齐？</p><p>以 C# 为例，我分别对值类型（存栈上）的 <code>struct</code> 实例和引用类型（引用存栈上，数据存堆上）的 <code>class</code> 实例进行内存大小检测。</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Foo</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ID <span class="token punctuation">&#123;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">short</span></span> Age <span class="token punctuation">&#123;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">char</span></span> Gender <span class="token punctuation">&#123;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">&#123;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 使布局连续以支持 Marshal.SizeOf 调用</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">StructLayout</span><span class="token attribute-arguments"><span class="token punctuation">(</span>LayoutKind<span class="token punctuation">.</span>Sequential<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> 
<span class="token keyword">class</span> <span class="token class-name">Bar</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ID <span class="token punctuation">&#123;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">short</span></span> Age <span class="token punctuation">&#123;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">&#123;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">char</span></span> Gender <span class="token punctuation">&#123;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">Program</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span> 
    <span class="token punctuation">&#123;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>Marshal<span class="token punctuation">.</span><span class="token function">SizeOf</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 16</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>Marshal<span class="token punctuation">.</span><span class="token function">SizeOf</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 24</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果显示，未作优化 <code>Bar</code> 类实例的内存占用高于 <code>Foo</code> 结构体实例。但需要注意的是，实际开发中，对类实例的内存对齐优化将交由 .NET 平台来完成。同理，在 JVM 中也是如此。</p><h2 id="栈和堆"><a href="#栈和堆" class="headerlink" title="栈和堆"></a>栈和堆</h2><p>这里讲的栈和堆指的是内存模型，而不是数据结构，虽然它们彼此具有相似的特性。在 C 中，存储区主要分为栈区、堆区、数据区和代码区。</p><p>在内存中，堆区位于内存的底部（低地址区），而栈区位于内存的顶部（高地址区）。</p><p>对一个程序来说，每个子程序（即函数）根据都会在内存中分配一个栈桢（Stack Frame），这些栈桢将会组成一个<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Call_stack">调用栈</a>（Call Stack）。栈桢的内存分配是根据彼此之间的调用关系，从栈区的顶部向低地址区进行分配的。栈桢的内存在到它调用完成后就被释放回收。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">sub2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> baz <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">sub1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> bar <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token function">sub2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> foo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">sub1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对于上述程序，将在内存中形成如下图所示的栈桢。<code>main</code> 函数将首先分配栈桢，之后依次是 <code>sub1</code>、<code>sub2</code>；然后当 <code>sub2</code> 调用结束后，其内存将会被立刻回收，之后回到 <code>sub1</code> 中继续执行，并最终回到 <code>main</code> 函数中，直到结束整个调用。这其实可以说是对栈的特性 LIFO（后进先出） 的一种应用。</p><img src="/2019/05/24/clang-notes/3.png" class="" title="图 3"><p>当然，对于每个栈桢内部而言，将对函数的参数列表、返回地址、局部变量等，按内存地址由低向高的顺序进行分配。这与堆区的内存分配是相同的。</p><p>堆的生存期是跟随整个程序进程的，而栈是函数运行时（Runtime）的。</p><h2 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h2><p>进程（Process）是操作系统的基本组成部分，是系统资源分配的基本单位——但在现在的多数面向线程（Thread）设计的操作系统（如 Linux 2.4 及更新版本）中，进程只不过是真正执行实体——线程——的容器，其本身只包含指令、数据及其组织形式的描述。即使说，进程实际上就是个<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/File_descriptor">文件描述者</a>（File Descriptor）或文件句柄（File Handle），它的值是一个无符号的长整型数字，它最终将索引到一个具体的文件上去（如图 4）。</p><img src="/2019/05/24/clang-notes/5.svg" class="" title="File_table_and_inode_table"><p>对于一个 CPU 而言，进程的处理是每个时刻只能处理一个进程的任务，但进程却是可以同时存在的。CPU 通过进行进程上下文的快速切换（时间极快）来实现同时执行的效果。线程的并行执行实际也是依赖于 CPU 对线程上下文的快速切换，当然对于多核 CPU 而言，可以将其分配到不同的内核进行处理。</p><img src="/2019/05/24/clang-notes/6.svg" alt="Multithreaded_process" width="240"><p>每一个进程的资源是独立分配的，它们相互之间是无法直接访问的。同一进程内的线程共享进程的资源。</p><p>在 Linux 系统中，对进程的管理有两个特殊的函数： <code>fork()</code> 和 <code>vfork()</code>。前者创建一个子进程，后者创建一个阻塞（Block）父进程的子进程。这两个函数会造成进程发生像细胞一样的分裂，且每次子进程都会继承父进程的资源，并自分裂处继续执行。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello, my pid is %d.\n"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上述的代码可能的输出：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Hello, my pid is <span class="token number">22715</span>.
Hello, my pid is <span class="token number">0</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>在 C 中进行线程编程使用的接口是 POSIX 或 Pthreads，这是由 <a target="_blank" rel="noopener" href="http://www.unix.org/version3/ieee_std.html">IEEE POSIX 1003.1c</a> 标准进行规定的。利用 <code>pthread.h</code> 头文件可以实现对线程的基本管理。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">print_hello</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> tid<span class="token punctuation">;</span>
    tid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span> <span class="token comment">/* 获取线程 ID */</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread #%ld: Hello World!\n"</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">pthread_t</span> thread<span class="token punctuation">;</span>
    <span class="token keyword">int</span> result<span class="token punctuation">;</span>
    <span class="token keyword">long</span> tid<span class="token punctuation">;</span>

    tid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">/* 指定一个线程 ID */</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In main: creating a thread %ld\n"</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> print_hello<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ERROR: code from pthread_create() is %d\n"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Last thing that main() should do */</span>
    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编译时，需要使用 <code>-lpthread</code> 进行链接。</p><h2 id="套接字"><a href="#套接字" class="headerlink" title="套接字"></a>套接字</h2><p>套接字是一种特殊的文件。为解决进程间的通讯而生。</p><img src="/2019/05/24/clang-notes/4.png" class="" title="图 5"><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol><li>Blaise Barney, Lawrence Livermore National Laboratory. <em><a target="_blank" rel="noopener" href="https://computing.llnl.gov/tutorials/pthreads/">POSIX Threads Programming</a></em></li></ol></div><script>document.querySelector(".post__content").addEventListener("click",function(e){var t=e.target,n=t.id;"H2"===t.nodeName&&n&&(location.hash="#"+n)})</script></div><hr style="border:1px dashed #eee"><div class="post--comment"></div><script type="x/template" id="comment-tmpl"><form>
      <p class="tip">加 * 为必填项，其中您输入的邮箱将不会公开！</p>
      <p>
        <label class="inline-block mb1">评论*</label>
        <textarea name="html_text" rows="4" class="block w100"></textarea>
      </p>
      <div class="clearfix">
        <p class="float--left w50 border-box" style="padding-right:5px;">
          <label class="inline-block mb1">昵称*</label>
          <input type="text" name="owner_name" class="block w100">
        </p>
        <p class="float--left w50 border-box" style="padding-left:5px;">
          <label class="inline-block mb1">邮箱*</label>
          <input type="email" name="owner_email" class="block w100">
        </p>
      </div>
      <p>
        <label class="inline-block mb1">网址</label>
        <input type="text" name="owner_website" class="block w100">
      </p>
      <p class="text-right"><button id="submitCommentBtn">发表评论</button></p>
    </form>
    <div class="comments">
      <!-- render comments here -->
    </div></script><script src="/js/talking.dev.js"></script><script>window.hexoThemeConfig={comment_sys_api:"https://www.sondge.club/tatwd/api/comments"}</script><script src="/js/post.js"></script></div></div></div></div></body></html>