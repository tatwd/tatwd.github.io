<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="ie=edge"><!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> --><meta name="generator" content="Hexo 5.3.0"><meta name="description" content="Redis 从 2.6.0 开始便支持执行 Lua 5.1 脚本，使用的命令是 EVAL。 基本语法： EVAL 脚本代码 键个数 键1 [键2 ...] 参数1 [参数2 ...] 在 Lua 脚本中，使用全局数组变量 KEYS 访问键，ARGV 访问参数，这两个变量都是从数组下标 1 开始进行访问。另外，如果需要执行 Redis 的指令，可以通过以下两个函数做到：  redis.call()"><meta property="og:type" content="article"><meta property="og:title" content="Lua 脚本在 Redis 中的应用"><meta property="og:url" content="https://jin.cloong.me/2021/03/04/lua-in-redis/index.html"><meta property="og:site_name" content="_King&#39;s Notes"><meta property="og:description" content="Redis 从 2.6.0 开始便支持执行 Lua 5.1 脚本，使用的命令是 EVAL。 基本语法： EVAL 脚本代码 键个数 键1 [键2 ...] 参数1 [参数2 ...] 在 Lua 脚本中，使用全局数组变量 KEYS 访问键，ARGV 访问参数，这两个变量都是从数组下标 1 开始进行访问。另外，如果需要执行 Redis 的指令，可以通过以下两个函数做到：  redis.call()"><meta property="og:locale"><meta property="article:published_time" content="2021-03-04T15:55:17.000Z"><meta property="article:modified_time" content="2021-03-04T16:02:19.148Z"><meta property="article:author" content="_king"><meta property="article:tag" content="Redis"><meta property="article:tag" content="Lua"><meta name="twitter:card" content="summary"><link rel="icon" href=""><title>_King&#39;s Notes</title><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Open+Sans|Roboto+Mono" rel="stylesheet"> --><!-- <link href="https://fonts.lug.ustc.edu.cn/css?family=Montserrat|Open+Sans|Roboto+Mono" rel="stylesheet"> --><link rel="stylesheet" href="/fonts/index.css"><link rel="stylesheet" href="/css/common.css"><style>.avatar::before{display:block;content:'';background:url(/img/avatar.jpg) no-repeat center;background-size:cover;border-radius:50%;border:1px solid #e6e6e6;height:62px;width:62px;margin:0 auto;margin-top:32px}</style><link rel="stylesheet" href="/css/post.css"><link rel="stylesheet" href="/css/prism.css"><link rel="stylesheet" href="/css/comment.css"><script>!function(){document.addEventListener("DOMContentLoaded",function(e){var o=window.decodeURI(location.hash.replace("#",""));if(""!==o){var t=document.getElementById(o);if(console.log(t),t){var n=t.offsetTop;setTimeout(function(){window.scrollTo(0,n-0)},0)}}});var e=(new Date).getHours();(e<6||18<=e)&&document.querySelector("html").setAttribute("theme","dark"),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){console.log(e)})}()</script><link rel="alternate" href="/atom.xml" title="_King's Notes" type="application/atom+xml"></head><body><div class="container"><div id="post"><div id="index__header"><div class="avatar text-center"></div><h2 class="h2 text-center text-upper"><a class="color--black" href="/">_King&#39;s Notes</a></h2><div class="text-center"><!-- github icon --> <a class="goto" href="https://github.com/tatwd" target="_blank"><svg class="icon" width="16" height="16" viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg> </a><a class="goto" href="mailto:tatwdo@gmail.com"><svg class="icon" width="16" height="16" viewBox="0 0 1024 1024" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M512 0a512 512 0 0 0 0 1024 42.666667 42.666667 0 0 0 0-85.333333 426.666667 426.666667 0 1 1 426.666667-426.666667v85.333333a85.333333 85.333333 0 1 1-169.386667 0V298.666667a42.666667 42.666667 0 0 0-85.333333 0v22.4a257.28 257.28 0 1 0 21.333333 359.253333A170.666667 170.666667 0 0 0 1024 597.333333v-85.333333A512 512 0 0 0 512 0z m0 683.946667A171.946667 171.946667 0 1 1 683.946667 512 172.16 172.16 0 0 1 512 683.946667z"></path></svg> </a><a class="goto" href="https://jin.cloong.me/atom.xml" target="_blank"><svg class="icon" width="16" height="16" viewBox="0 0 1024 1024" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M320.374394 768q0 45.714286-32 77.714286t-77.714285 32-77.714286-32-32-77.714286 32-77.714286 77.714286-32 77.714285 32 32 77.714286z m292.571429 70.285714q1.142857 16-9.714286 27.428572-10.285714 12-26.857143 12H499.231537q-14.285714 0-24.571428-9.428572t-11.428572-23.714285q-12.571429-130.857143-105.428571-223.714286T134.08868 515.428571q-14.285714-1.142857-23.714286-11.428571T100.945823 479.428571V402.285714q0-16.571429 12-26.857143 9.714286-9.714286 24.571428-9.714285h2.857143q91.428571 7.428571 174.857143 46T463.231537 515.428571q65.142857 64.571429 103.714286 148t46 174.857143z m292.571428 1.142857q1.142857 15.428571-10.285714 26.857143-10.285714 11.428571-26.285714 11.428572h-81.714286q-14.857143 0-25.428571-10T750.660109 843.428571q-6.857143-122.857143-57.714286-233.428571t-132.285714-192-192-132.285714T135.231537 227.428571q-14.285714-0.571429-24.285714-11.142857T100.945823 191.428571V109.714286q0-16 11.428571-26.285715 10.285714-10.285714 25.142857-10.285714h1.714286q149.714286 7.428571 286.571429 68.571429T668.945823 309.714286q106.857143 106.285714 168 243.142857t68.571428 286.571428z"></path></svg></a></div></div><div id="post__mainer"><div class="sm-container"><div class="post--body"><div class="post__title"><span>2021-03-04</span><h1 class="h1 text-upper">Lua 脚本在 Redis 中的应用</h1></div><div class="post__content"><p>Redis 从 2.6.0 开始便支持执行 Lua 5.1 脚本，使用的命令是 <a target="_blank" rel="noopener" href="https://redis.io/commands/eval"><code>EVAL</code></a>。</p><p>基本语法：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">EVAL 脚本代码 键个数 键1 [键2 ...] 参数1 [参数2 ...]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在 Lua 脚本中，使用全局数组变量 <code>KEYS</code> 访问键，<code>ARGV</code> 访问参数，这两个变量都是<strong>从数组下标 1 开始</strong>进行访问。另外，如果需要执行 Redis 的指令，可以通过以下两个函数做到：</p><ul><li><code>redis.call()</code></li><li><code>redis.pcall()</code></li></ul><p>前者在执行发生错误时会抛给执行者，而后者不会。</p><p>这个脚本的执行过程是一个<strong>事务操作</strong>，并且是 Redis 中一种更快速和高效的（simpler and faster）事务执行方式，它的效果相当于 <code>MULTI</code> + <code>EXEC</code>。这一特性的存在，让我们可以在一次指令执行中（一次通信）包含一系列可程序化的操作。在一定程度上，可以简化客户端代码及可能存在的并发问题。</p><p>例如，下面脚本实现的功能是对一个 key 进行计数并在首次缓存时设置过期时间，执行返回的结果是当前计数值：</p><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> key <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token keyword">local</span> seconds <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> count <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'incr'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>

<span class="token keyword">if</span> count <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">then</span>
  redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'expire'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> seconds<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">return</span> count<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从这个例子可以看出，Lua 脚本在此时扮演的角色实际上等同于一个“函数”，对这段脚本的执行就相当于在执行一个“函数”，所不同于一般函数的是 Redis 保证其执行具有了原子性。</p><p>但需要注意的是，尽量不要在脚本中执行大量耗时的操作（如 <code>keys *</code>），否则可能会对其他 client 造成一定影响。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol><li><a target="_blank" rel="noopener" href="https://redis.io/commands/eval">Redis Lua scripting</a></li><li><a target="_blank" rel="noopener" href="https://redis.io/topics/transactions">Redis transactions</a></li><li><a target="_blank" rel="noopener" href="http://www.lua.org/manual/5.1/">Lua 5.1 Reference Manual</a></li></ol></div><script>document.querySelector(".post__content").addEventListener("click",function(e){var t=e.target,n=t.id;"H2"===t.nodeName&&n&&(location.hash="#"+n)})</script></div><hr style="border:1px dashed #eee"><div class="post--comment"></div><script type="x/template" id="comment-tmpl"><form>
      <p class="tip">加 * 为必填项，其中您输入的邮箱将不会公开！</p>
      <p>
        <label class="inline-block mb1">评论*</label>
        <textarea name="html_text" rows="4" class="block w100"></textarea>
      </p>
      <div class="clearfix">
        <p class="float--left w50 border-box" style="padding-right:5px;">
          <label class="inline-block mb1">昵称*</label>
          <input type="text" name="owner_name" class="block w100">
        </p>
        <p class="float--left w50 border-box" style="padding-left:5px;">
          <label class="inline-block mb1">邮箱*</label>
          <input type="email" name="owner_email" class="block w100">
        </p>
      </div>
      <p>
        <label class="inline-block mb1">网址</label>
        <input type="text" name="owner_website" class="block w100">
      </p>
      <p class="text-right"><button id="submitCommentBtn">发表评论</button></p>
    </form>
    <div class="comments">
      <!-- render comments here -->
    </div></script><script src="/js/talking.dev.js"></script><script>window.hexoThemeConfig={comment_sys_api:"https://www.sondge.club/tatwd/api/comments"}</script><script src="/js/post.js"></script></div></div></div></div></body></html>